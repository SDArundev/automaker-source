# 04 — UI Deep Dive

## Boot Sequence

1. `index.html` loads with inline theme-flash-prevention script (reads localStorage)
2. `renderer.tsx` creates React root, renders `<App />`
3. `app.tsx` initializes hooks: settings sync, cursor status, provider auth
4. Shows SplashScreen on first session load
5. `<RouterProvider>` renders TanStack Router

**Electron mode extras:**
- `main.ts` (1007 lines) finds ports, generates CSRF API key, spawns backend, waits for health check, creates BrowserWindow
- IPC handlers: dialog:openDirectory, shell:openExternal, server:getUrl, auth:getApiKey, etc.

## Routing (22 Routes)

| Route | View | Shortcut |
|-------|------|----------|
| `/board` | KanbanBoard | K |
| `/agent` | AgentChat | A |
| `/spec` | SpecEditor | D |
| `/context` | ContextManager | C |
| `/settings` | GlobalSettings | S |
| `/project-settings` | ProjectSettings | Shift+S |
| `/terminal` | Terminal | T |
| `/graph` | DependencyGraph | H |
| `/ideation` | AIBrainstorm | I |
| `/memory` | MemoryView | Y |
| `/github-issues` | GitHubIssues | G |
| `/github-prs` | GitHubPRs | R |
| `/notifications` | Notifications | X |
| `/running-agents` | RunningAgents | - |
| `/wiki` | Wiki | - |
| `/interview` | Interview | - |
| `/dashboard` | ProjectSelection | - |
| `/setup` | SetupWizard | - |
| `/login` | Login | - |

**Root layout** (`__root.tsx`, 916 lines): Authentication brain, theme application, sidebar rendering, sandbox checks.

## State Management (5 Zustand Stores)

### app-store.ts (4242 lines) — The mega store
Everything lives here:
- **Projects:** projects[], currentProject, trashedProjects, projectHistory
- **Features/Kanban:** features[], status management, planSpec
- **Chat:** chatSessions, currentChatSession
- **Auto Mode:** per-worktree state (isRunning, maxConcurrency)
- **Board:** viewMode (kanban/graph), backgrounds, pipeline config
- **Theme:** 40+ themes, previewTheme, fonts
- **Shortcuts:** 30+ customizable keyboard shortcuts
- **Models:** phaseModels, favoriteModels, provider configs
- **MCP:** mcpServers configuration
- **Terminal:** tabs, splits, sessions, fonts, scrollback
- **Usage:** claudeUsage, codexUsage tracking
- **Prompts:** promptCustomization
- **Event Hooks:** eventHooks[]

Settings sync: `use-settings-sync.ts` watches store changes, debounces, pushes to server API.

### auth-store.ts (35 lines)
`authChecked`, `isAuthenticated`, `settingsLoaded` — NOT persisted.

### setup-store.ts (294 lines)
Setup wizard: 10 steps from welcome → complete. CLI detection statuses.

### ideation-store.ts (339 lines)
Ideas, generation jobs, analysis. **Persisted** via Zustand `persist` middleware.

### notifications-store.ts (130 lines)
Notifications, unreadCount. NOT persisted.

## Key Components

### Board View (`board-view.tsx`, 1796 lines)
The central feature:
- `DndContext` wrapping `WorktreePanel` + `KanbanBoard`/`ListView`
- 20+ dialog components (AddFeature, EditFeature, PlanApproval, CreatePR, etc.)
- 12 custom hooks in `board-view/hooks/`
- Virtualized lists for columns with 40+ cards

### Kanban DnD Implementation (dnd-kit)
- Custom `DialogAwarePointerSensor` (ignores drags from dialogs)
- 8px activation distance threshold
- Custom collision detection: card drops → column collisions → fallback
- Drag actions:
  - Card → Column: change status
  - Card → Card: create dependency link
  - Card → Worktree: assign to branch
- `DragOverlay` renders floating card during drag

### Agent View
- WebSocket-based communication via `useElectronAgent` hook
- `ChatArea` + `AgentInputArea` with file preview
- Session management with multiple chat sessions

### Terminal View
- `react-resizable-panels` for splits
- Tab-based with DnD tab reordering
- Recursive split layout (`TerminalPanelContent`)
- xterm.js instances with error boundaries

### Graph View (@xyflow/react)
- Custom `TaskNode` and `DependencyEdge` components
- MiniMap, connection mode for creating dependencies
- Compact vs full render mode based on node/edge count

## Theme System (40 Themes)

20 dark + 20 light themes. Architecture:
1. Theme class (e.g., `dracula`) applied to `<html>`
2. Each theme CSS file defines CSS variables (`--background`, `--foreground`, etc.)
3. Tailwind CSS 4 `@custom-variant` maps theme classes to utilities
4. Flash prevention: inline `<script>` in `index.html` reads localStorage before React hydrates
5. Per-project overrides via `project.theme`

## API Client (`lib/http-api-client.ts`, 2702 lines)

Dual-mode architecture:
- **Electron:** API key via IPC, `X-API-Key` header
- **Web:** Session cookie, `X-Session-Token` header

`getElectronAPI()` returns `window.electronAPI` (Electron) or HTTP client (web).

API namespaces: `fs`, `features`, `autoMode`, `settings`, `worktree`, `git`, `sessions`, `github`, `ideation`, `notifications`, `pipeline`, `suggestions`, `specRegeneration`, `backlogPlan`, `usage`, `eventHistory`

React Query integration with typed query keys across 17+ entity types.

## Keyboard Shortcuts

30+ customizable shortcuts. Format: `"K"`, `"Shift+N"`, `"Cmd+K"`, `"Alt+D"`.

Guards: suppressed in input/textarea/contenteditable/xterm/dialogs/dropdowns.

## Real-Time Updates

- Auto mode events: feature_start, complete, error, plan_approval_required
- Agent streaming via `useElectronAgent` hook
- Init script events, suggestion events, spec regeneration events
- React Query cache invalidated on relevant events
- Global custom events: `automaker:logged-out`, `automaker:server-offline`
